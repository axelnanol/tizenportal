<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TizenPortal v0.2.0</title>
    <style>
        body { background: #000; color: #fff; font-family: "Segoe UI", sans-serif; margin: 0; padding: 40px; overflow: hidden; }
        
        header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        
        .card { 
            background: #1a1a1a; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; 
            border: 4px solid transparent; border-radius: 8px; font-weight: bold; font-size: 20px; 
            flex-direction: column; gap: 10px; cursor: pointer; opacity: 0.7; transition: transform 0.1s;
        }
        .card img { width: 50px; height: 50px; object-fit: contain; }
        
        .card.active, .card:focus { 
            border-color: #FFD700; background: #333; opacity: 1;
            transform: scale(1.05); z-index: 10; box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            outline: none;
        }
        
        .add { border: 4px dashed #333; color: #666; }
        .add.active { border-color: #FFD700; color: #fff; }

        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 40px; width: 600px; display: flex; flex-direction: column; gap: 15px; border: 2px solid #555; }
        input, select { padding: 15px; background: #111; color: white; border: 1px solid #444; width: 100%; font-size: 18px; }
        input:focus, select:focus, button:focus { border-color: #FFD700; outline: none; }
        
        .btn-row { display: flex; gap: 15px; margin-top: 10px; }
        button { flex: 1; padding: 15px; background: #333; color: white; border: 1px solid #555; font-size: 16px; font-weight: bold; }
        button.primary { background: #FFD700; color: black; border-color: #FFD700; }
        
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header>
        <h1>TizenPortal <span style="font-size:14px; color:#666;">v0.2.0</span></h1>
    </header>
    
    <div id="grid" class="grid"></div>
    <div id="toast">Long Press Enter to Edit</div>

    <div id="modal">
        <div class="box">
            <h2 id="modal-title">Add App</h2>
            <input type="text" id="name" placeholder="Name">
            <input type="url" id="url" placeholder="URL">
            <select id="preset"><option value="">-- No Preset --</option></select>
            <select id="ua"></select>
            <div class="btn-row">
                <button onclick="closeModal()">Cancel</button>
                <button onclick="save()" class="primary">Save</button>
            </div>
            <button id="btn-delete" onclick="deleteApp()" style="margin-top:10px; background:#500; border:none; display:none;">Delete App</button>
        </div>
    </div>

    <script>
        // DATA
        var PRESETS = {
            "__CORE__": { "css": "img,svg,video{max-width:100%!important;height:auto!important}:focus{outline:5px solid #FFD700!important}::-webkit-scrollbar{display:none}", "js": "window.TizenUtils={keepAwake:function(){try{var v=document.createElement('video');v.src='https://raw.githubusercontent.com/anthonium/Gestures/master/blank.mp4';v.loop=true;v.play();document.body.appendChild(v)}catch(e){}}};window.TizenUtils.keepAwake();" },
            "abs": { "name": "Audiobookshelf", "css": ".flex{gap:0!important}", "js": "" },
            "jellyfin": { "name": "Jellyfin", "css": ":focus-visible{outline:4px solid #FFD700!important}", "js": "" }
        };
        var USER_AGENTS = [
            { id: "default", name: "ðŸ“º Tizen (Default)", str: null },
            { id: "mobile",  name: "ðŸ“± Mobile (Android)", str: "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Mobile Safari/537.36" },
            { id: "desktop", name: "ðŸ’» Desktop (PC)",     str: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" }
        ];

        var apps = JSON.parse(localStorage.getItem('tp_apps') || '[]');
        var selectedIndex = 0;
        var editIndex = -1;
        var pressTimer = null;

        function init() {
            if (typeof tizen !== 'undefined' && tizen.tvinputdevice) {
                var keys = ["ColorF0Red", "ColorF1Green", "ColorF2Yellow", "ColorF3Blue", "MediaPlay", "MediaPause"];
                for (var i = 0; i < keys.length; i++) { try { tizen.tvinputdevice.registerKey(keys[i]); } catch(e){} }
            }
            var selP = document.getElementById('preset');
            Object.keys(PRESETS).forEach(function(k) { if(k!=='__CORE__') selP.innerHTML+='<option value="'+k+'">'+PRESETS[k].name+'</option>'; });
            var selU = document.getElementById('ua');
            USER_AGENTS.forEach(function(u) { selU.innerHTML+='<option value="'+u.id+'">'+u.name+'</option>'; });

            render();
            showToast("Long Press Enter to Edit");
            setInterval(enforceFocus, 200);
        }

        function render() {
            var g = document.getElementById('grid'); g.innerHTML = '';
            apps.forEach(function(a, i) {
                var d = document.createElement('div');
                d.className = 'card'; d.tabIndex = 0;
                d.innerHTML = '<img src="https://s2.googleusercontent.com/s2/favicons?domain_url='+encodeURIComponent(a.url)+'&sz=64"><span>'+a.name+'</span>';
                g.appendChild(d);
            });
            var add = document.createElement('div'); add.className = 'card add'; add.tabIndex = 0;
            add.innerHTML = '<i class="fas fa-plus"></i><span>Add App</span>';
            g.appendChild(add);
            updateSelection();
        }

        function updateSelection() {
            var cards = document.querySelectorAll('.card');
            if (selectedIndex >= cards.length) selectedIndex = cards.length - 1;
            if (selectedIndex < 0) selectedIndex = 0;
            for (var i = 0; i < cards.length; i++) {
                if (i === selectedIndex) { cards[i].classList.add('active'); cards[i].focus(); } 
                else { cards[i].classList.remove('active'); }
            }
        }

        function enforceFocus() {
            if(document.getElementById('modal').style.display === 'flex') return;
            var cards = document.querySelectorAll('.card');
            if(cards[selectedIndex] && document.activeElement !== cards[selectedIndex]) cards[selectedIndex].focus();
        }

        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            if(document.getElementById('modal').style.display === 'flex') { if(k===10009||k===27) closeModal(); return; }
            var cols = Math.floor(document.getElementById('grid').offsetWidth / 250) || 3;
            if (k===37) selectedIndex--; if (k===39) selectedIndex++; 
            if (k===38) selectedIndex-=cols; if (k===40) selectedIndex+=cols; 
            if ([37,38,39,40].includes(k)) { e.preventDefault(); updateSelection(); }
            if (k===13 && !pressTimer) { pressTimer = setTimeout(function() { pressTimer=null; openModal(selectedIndex); }, 800); }
        });

        document.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) {
                if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; 
                    if (selectedIndex === document.querySelectorAll('.card').length-1) openModal(-1); else launch(apps[selectedIndex]); 
                }
            }
        });

        function launch(app) {
            var core = PRESETS['__CORE__'];
            var preset = PRESETS[app.presetID] || {};
            var uaObj = USER_AGENTS.find(function(u){ return u.id === app.ua }) || USER_AGENTS[0];
            var payload = { css: (core.css||'')+'\n'+(preset.css||''), js: (core.js||'')+'\n'+(preset.js||''), ua: uaObj.str };
            var b64 = btoa(JSON.stringify(payload));
            var sep = app.url.indexOf('?') > -1 ? '&' : '?';
            window.location.href = app.url + sep + 'tp=' + b64;
        }

        function openModal(index) { 
            editIndex = index;
            var isAdd = (index === -1 || index >= apps.length);
            document.getElementById('modal-title').innerText = isAdd ? "Add App" : "Edit App";
            document.getElementById('btn-delete').style.display = isAdd ? 'none' : 'block';
            if (!isAdd) {
                var a = apps[index];
                document.getElementById('name').value = a.name; document.getElementById('url').value = a.url;
                document.getElementById('preset').value = a.presetID || ""; document.getElementById('ua').value = a.ua || "default";
            } else { document.getElementById('name').value = ""; document.getElementById('url').value = ""; }
            document.getElementById('modal').style.display='flex'; document.getElementById('name').focus(); 
        }

        function closeModal() { document.getElementById('modal').style.display='none'; }
        function save() {
            var name=document.getElementById('name').value; var url=document.getElementById('url').value;
            if(name && url) {
                var appObj = {name:name, url:url, presetID:document.getElementById('preset').value, ua:document.getElementById('ua').value};
                if (editIndex > -1 && editIndex < apps.length) apps[editIndex] = appObj; else { apps.push(appObj); selectedIndex = apps.length-1; }
                localStorage.setItem('tp_apps', JSON.stringify(apps));
                closeModal(); render();
            }
        }
        function deleteApp() { if(editIndex > -1 && confirm("Delete?")) { apps.splice(editIndex, 1); localStorage.setItem('tp_apps', JSON.stringify(apps)); selectedIndex=Math.max(0,editIndex-1); closeModal(); render(); } }
        function showToast(msg) { var t=document.getElementById('toast'); t.innerText=msg; t.style.opacity=1; setTimeout(function(){t.style.opacity=0;},5000); }
        init();
    </script>
</body>
</html>