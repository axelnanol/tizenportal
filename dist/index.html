<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TizenPortal v0.1.5</title>
    <style>
        body { background: #000; color: #fff; font-family: "Segoe UI", sans-serif; margin: 0; padding: 40px; overflow: hidden; }
        
        header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        
        /* CARD STYLES */
        .card { 
            background: #1a1a1a; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; 
            border: 4px solid transparent; border-radius: 8px; font-weight: bold; font-size: 20px; 
            flex-direction: column; gap: 10px; cursor: pointer; opacity: 0.7;
        }
        .card img { width: 50px; height: 50px; object-fit: contain; }
        .card i { font-size: 40px; color: #888; }
        
        /* ACTIVE STATE */
        .card.active { 
            border-color: #FFD700; background: #333; opacity: 1;
            transform: scale(1.05); z-index: 10; box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        .add { border: 4px dashed #333; color: #666; }
        .add.active { border-color: #FFD700; color: #fff; }

        /* MODAL */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 40px; width: 500px; display: flex; flex-direction: column; gap: 15px; border: 2px solid #555; }
        input, select { padding: 15px; background: #111; color: white; border: 1px solid #444; width: 100%; font-size: 18px; }
        input:focus, select:focus, button:focus { border-color: #FFD700; outline: none; }
        
        .btn-row { display: flex; gap: 15px; margin-top: 10px; }
        button { flex: 1; padding: 15px; background: #333; color: white; border: 1px solid #555; font-size: 16px; font-weight: bold; }
        button.primary { background: #FFD700; color: black; border-color: #FFD700; }

        /* KEY DEBUGGER */
        #key-debug { position: fixed; bottom: 10px; right: 10px; font-family: monospace; color: #444; font-size: 12px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header>
        <h1>TizenPortal <span style="font-size:14px; color:#666;">v0.1.5</span></h1>
    </header>
    
    <div id="grid" class="grid"></div>

    <div id="modal">
        <div class="box">
            <h2>Add App</h2>
            <input type="text" id="name" placeholder="App Name" autocomplete="off">
            <input type="url" id="url" placeholder="http://192.168.1.X:PORT" autocomplete="off">
            <select id="preset"><option value="">-- No Preset --</option></select>
            <select id="ua">
                <option value="default">TV (Default)</option>
                <option value="desktop">PC (Desktop Mode)</option>
            </select>
            <div class="btn-row">
                <button onclick="closeModal()">Cancel</button>
                <button onclick="save()" class="primary">Save</button>
            </div>
            <button onclick="deleteApp()" style="margin-top:10px; background:#500; border:none;">Delete App</button>
        </div>
    </div>
    
    <div id="key-debug">Last Key: None</div>

    <script>
        // --- 1. TIZEN KEY REGISTRATION (THE FIX) ---
        function registerKeys() {
            if (typeof tizen !== 'undefined' && tizen.tvinputdevice) {
                const keys = ["ColorF0Red", "ColorF1Green", "ColorF2Yellow", "ColorF3Blue", "MediaPlay", "MediaPause", "MediaStop", "MediaFastForward", "MediaRewind"];
                keys.forEach(k => {
                    try {
                        tizen.tvinputdevice.registerKey(k);
                        console.log("Registered:", k);
                    } catch(e) { console.error("Key Reg Fail:", k); }
                });
            } else {
                console.warn("Tizen API not found (Browser Mode?)");
            }
        }

        // --- 2. DATA & PRESETS ---
        const PRESETS = {
            "__CORE__": {
                "css": "img, svg, video { max-width: 100% !important; height: auto !important; } :focus { outline: 5px solid #FFD700 !important; } ::-webkit-scrollbar { display: none; }",
                "js": "window.TizenUtils={keepAwake:()=>{try{const v=document.createElement('video');v.src='https://raw.githubusercontent.com/anthonium/Gestures/master/blank.mp4';v.loop=true;v.play();document.body.appendChild(v);}catch(e){}}};window.TizenUtils.keepAwake();"
            },
            "abs": { "name": "Audiobookshelf", "css": ".flex { gap: 0 !important; }", "js": "" },
            "jellyfin": { "name": "Jellyfin", "css": ":focus-visible { outline: 4px solid #FFD700 !important; }", "js": "" }
        };

        const UA_STRINGS = {
            "desktop": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36"
        };

        let apps = JSON.parse(localStorage.getItem('tp_apps') || '[]');
        let selectedIndex = 0; 

        // --- 3. RENDER & NAV ---
        function init() {
            registerKeys(); // Call immediately
            const sel = document.getElementById('preset');
            Object.keys(PRESETS).forEach(k => { if(k!=='__CORE__') sel.innerHTML+=`<option value="${k}">${PRESETS[k].name}</option>`; });
            render();
        }

        function render() {
            const g = document.getElementById('grid'); g.innerHTML = '';
            apps.forEach((a, i) => {
                const d = document.createElement('div');
                d.className = 'card';
                d.innerHTML = `<img src="https://s2.googleusercontent.com/s2/favicons?domain_url=${encodeURIComponent(a.url)}&sz=64"><span>${a.name}</span>`;
                g.appendChild(d);
            });
            const add = document.createElement('div'); add.className = 'card add';
            add.innerHTML = `<i class="fas fa-plus"></i><span>Add App</span>`;
            g.appendChild(add);
            updateSelection();
        }

        function updateSelection() {
            const cards = document.querySelectorAll('.card');
            if (selectedIndex >= cards.length) selectedIndex = cards.length - 1;
            if (selectedIndex < 0) selectedIndex = 0;
            cards.forEach((c, i) => {
                if (i === selectedIndex) c.classList.add('active');
                else c.classList.remove('active');
            });
        }

        // --- 4. INPUT HANDLING ---
        document.addEventListener('keydown', (e) => {
            const k = e.keyCode;
            document.getElementById('key-debug').innerText = "Last Key: " + k;

            // COLOR KEYS (Test if they work in launcher)
            if(k === 403) alert("Red Key Works!"); 

            const modal = document.getElementById('modal').style.display === 'flex';
            const cards = document.querySelectorAll('.card');
            const cols = Math.floor(document.getElementById('grid').offsetWidth / 250) || 3;

            if(modal) {
                if(k === 10009 || k === 27) closeModal();
                return;
            }

            if (k === 37) selectedIndex--; 
            if (k === 39) selectedIndex++; 
            if (k === 38) selectedIndex -= cols; 
            if (k === 40) selectedIndex += cols; 

            if ([37,38,39,40].includes(k)) {
                e.preventDefault();
                updateSelection();
            }

            if (k === 13) {
                const isAddBtn = (selectedIndex === cards.length - 1);
                if (isAddBtn) openModal();
                else launch(apps[selectedIndex]);
            }
        });

        function launch(app) {
            const core = PRESETS['__CORE__'];
            const preset = PRESETS[app.presetID] || {};
            const payload = {
                css: (core.css||'') + '\n' + (preset.css||''),
                js: (core.js||'') + '\n' + (preset.js||''),
                ua: UA_STRINGS[app.ua] || null
            };
            
            const json = JSON.stringify(payload);
            const b64 = btoa(json);
            const separator = app.url.includes('?') ? '&' : '?';
            const target = app.url + separator + 'tp=' + b64;
            
            window.location.href = target;
        }

        // --- 5. MODAL LOGIC ---
        function openModal() { document.getElementById('modal').style.display='flex'; document.getElementById('name').focus(); }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function save() {
            const name = document.getElementById('name').value;
            const url = document.getElementById('url').value;
            const preset = document.getElementById('preset').value;
            const ua = document.getElementById('ua').value;
            if(name && url) {
                apps.push({name, url, presetID: preset, ua});
                localStorage.setItem('tp_apps', JSON.stringify(apps));
                location.reload();
            }
        }
        function deleteApp() { apps.pop(); localStorage.setItem('tp_apps', JSON.stringify(apps)); location.reload(); }

        init();
    </script>
</body>
</html>