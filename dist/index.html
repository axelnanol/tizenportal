<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TizenPortal 047</title>
    <style>
        body { background: #000; color: #fff; font-family: "Segoe UI", sans-serif; margin: 0; padding: 40px; overflow: hidden; }
        header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        .card { 
            background: #1a1a1a; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; 
            border: 4px solid transparent; border-radius: 8px; font-weight: bold; font-size: 20px; 
            flex-direction: column; gap: 10px; cursor: pointer; opacity: 0.7; transition: transform 0.1s;
            overflow: hidden !important; position: relative; max-width: 100%; min-width: 0;
        }
        .icon-box { width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .icon-box img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .icon-box i { font-size: 50px; color: #888; display: none; }
        .card.active, .card:focus { 
            border-color: #FFD700; background: #333; opacity: 1; transform: scale(1.05); z-index: 10; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); outline: none;
        }
        .add { border: 4px dashed #333; color: #666; }
        .add.active { border-color: #FFD700; color: #fff; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 40px; width: 600px; display: flex; flex-direction: column; gap: 15px; border: 2px solid #555; }
        input, select { padding: 15px; background: #111; color: white; border: 1px solid #444; width: 100%; font-size: 18px; }
        input:focus, select:focus, button:focus { border-color: #FFD700; outline: none; }
        .btn-row { display: flex; gap: 15px; margin-top: 10px; }
        button { flex: 1; padding: 15px; background: #333; color: white; border: 1px solid #555; font-size: 16px; font-weight: bold; }
        button.primary { background: #FFD700; color: black; border-color: #FFD700; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header><h1>TizenPortal <span style="font-size:14px; color:#666;">047</span></h1></header>
    <div id="grid" class="grid"></div>
    <div id="toast">Long Press Enter to Edit</div>
    <div id="modal">
        <div class="box">
            <h2 id="modal-title">Add App</h2>
            <input type="text" id="name" placeholder="Name">
            <input type="url" id="url" placeholder="URL">
            <select id="preset"><option value="">-- No Preset --</option></select>
            <select id="ua"></select>
            <div class="btn-row"><button onclick="closeModal()">Cancel</button><button onclick="save()" class="primary">Save</button></div>
            <button id="btn-delete" onclick="deleteApp()" style="margin-top:10px; background:#500; border:none; display:none;">Delete App</button>
        </div>
    </div>

    <script id="abs-css" type="text/template">
        /* 1. GLOBAL BASICS */
        body { 
            background-color: #222 !important; 
            margin: 0 !important; padding: 20px !important; 
            overflow-y: auto !important; 
            font-family: sans-serif !important; 
            color: #fff !important; 
        }

        /* 3. LIFEBOAT MODE (Default) */
        /* We hide the broken app unless we are in form mode. 
           NOTE: Chrome 47 does not support complex :not(.class *) selectors, so we hide by default.
           The .tp-form-mode #__nuxt rule above will override this due to higher specificity. */
        .tp-lifeboat-active #__nuxt { 
            opacity: 0.001 !important; 
            pointer-events: none !important; 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            z-index: -100 !important;
        }
        
        #tp-lifeboat { display: block; width: 100%; padding-bottom: 50px; margin-top: 70px; }
        #tp-navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(0,0,0,0.9); border-bottom: 2px solid #b8860b; display: flex; align-items: center; padding: 0 20px; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .tp-nav-item { color: #ddd; font-size: 18px; margin-right: 20px; cursor: pointer; padding: 10px; border: 1px solid transparent; }
        .tp-nav-item:focus, .tp-nav-item:hover { color: #FFD700; border-color: #FFD700; background: #333; outline: none; }
    </script>
    
    <script id="abs-js" type="text/template">
        // ABS Lifeboat - State Machine with MutationObserver
        var ABS = {
            state: 'INIT', // INIT -> WAIT_NUXT -> DETECT_PAGE -> READY
            boat: null,
            nav: null,
            observer: null,
            cache: { processedBooks: {}, processedHeadings: {} },
            ui: { debugBanner: null },
            
            log: function(msg) {
                console.log('[TP ABS] ' + msg);
                if (!this.ui.debugBanner) {
                    var b = document.createElement('div');
                    b.id = 'tp-debug';
                    b.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:2147483647;background:rgba(0,0,0,0.8);color:#FFD700;font-size:14px;font-family:sans-serif;padding:6px 10px;pointer-events:none;text-align:left;';
                    document.body.appendChild(b);
                    this.ui.debugBanner = b;
                }
                this.ui.debugBanner.textContent = '[TP ABS] ' + msg;
            },
            
            init: function() {
                this.log('Initializing ABS lifeboat');
                this.state = 'WAIT_NUXT';
                this.waitForNuxt();
            },
            
            waitForNuxt: function() {
                if (typeof window.__NUXT__ !== 'undefined' || document.querySelectorAll('[id*="__nuxt"]').length > 0) {
                    this.log('Nuxt detected, creating lifeboat');
                    this.createLifeboat();
                    this.setupMutationObserver();
                    this.state = 'DETECT_PAGE';
                } else {
                    setTimeout(this.waitForNuxt.bind(this), 100);
                }
            },
            
            createLifeboat: function() {
                if (this.boat) return;
                
                this.boat = document.createElement('div');
                this.boat.id = 'tp-lifeboat';
                
                this.nav = document.createElement('div');
                this.nav.id = 'tp-navbar';
                
                // Extract home URL from Nuxt config
                var homeUrl = '/';
                if (window.__NUXT__ && window.__NUXT__.config && window.__NUXT__.config.routerBasePath) {
                    homeUrl = window.__NUXT__.config.routerBasePath;
                }
                
                // Extract and apply background immediately
                this.extractBackground();
                
                // Add Home button
                var homeBtn = document.createElement('div');
                homeBtn.className = 'tp-nav-item';
                homeBtn.innerText = 'Home';
                homeBtn.tabIndex = 0;
                homeBtn.onclick = function() { TizenUtils.navigate(homeUrl); };
                homeBtn.onkeydown = function(e) { if (e.keyCode === 13) TizenUtils.navigate(homeUrl); };
                this.nav.appendChild(homeBtn);
                
                document.body.appendChild(this.nav);
                document.body.appendChild(this.boat);
                this.log('Lifeboat created');
            },
            
            extractBackground: function() {
                var bgImg = '';
                var searchEls = [
                    document.querySelector('.bg-bg-background'),
                    document.querySelector('[class*="background"]'),
                    document.querySelector('[class*="bg"]'),
                    document.querySelector('[style*="background"]'),
                    document.getElementById('__nuxt'),
                    document.body
                ];
                
                for (var s = 0; s < searchEls.length; s++) {
                    var el = searchEls[s];
                    if (!el) continue;
                    if (el.style && el.style.backgroundImage) {
                        bgImg = el.style.backgroundImage;
                        this.log('BG from inline style');
                        break;
                    }
                    var cs = window.getComputedStyle(el);
                    if (cs && cs.backgroundImage && cs.backgroundImage !== 'none') {
                        bgImg = cs.backgroundImage;
                        this.log('BG from computed style');
                        break;
                    }
                }
                
                if (bgImg) {
                    document.body.style.backgroundImage = bgImg;
                    document.body.style.backgroundRepeat = 'no-repeat';
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                }
            },
            
            setupMutationObserver: function() {
                var self = this;
                this.observer = new MutationObserver(function(mutations) {
                    // Check if page is loading
                    var loader = document.getElementById('nuxt-loading');
                    if (loader && getComputedStyle(loader).opacity !== '0') return;
                    
                    self.detectAndRender();
                });
                
                this.observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: false
                });
            },
            
            detectAndRender: function() {
                if (this.state !== 'DETECT_PAGE' && this.state !== 'READY') return;
                
                // Detect if we're on a login page or content page
                var hasBooks = document.querySelectorAll('[id^="book-card-"]').length > 0;
                var hasInputs = this.getVisibleInputs().length > 0;
                
                if (!hasBooks && hasInputs) {
                    this.renderLoginForm();
                    this.state = 'READY';
                } else if (hasBooks) {
                    this.renderContent();
                    this.state = 'READY';
                    // Toggle visibility based on content
                    if (this.boat.childElementCount > 0) {
                        document.body.classList.add('tp-lifeboat-active');
                    }
                }
            },
            
            getVisibleInputs: function() {
                var all = document.querySelectorAll('input, textarea, select, button');
                var visible = [];
                for (var i = 0; i < all.length; i++) {
                    if (all[i].offsetParent !== null && all[i].style.display !== 'none' && all[i].style.visibility !== 'hidden') {
                        visible.push(all[i]);
                    }
                }
                return visible;
            },
            
            renderLoginForm: function() {
                if (window.TizenUtils && window.TizenUtils.handleLogin) {
                    window.TizenUtils.handleLogin(this.boat, 'Audiobookshelf');
                    this.log('Login form rendered');
                }
            },
            
            renderContent: function() {
                if (this.boat.childElementCount > 0) return; // Already rendered
                
                var containers = document.querySelectorAll('div.relative');
                var bookCount = 0;
                
                for (var i = 0; i < containers.length; i++) {
                    var cont = containers[i];
                    
                    // Extract headings
                    var placard = cont.querySelector('.categoryPlacard');
                    if (placard) {
                        var text = placard.textContent.trim();
                        var headerId = 'tp-head-' + i;
                        if (!this.cache.processedHeadings[headerId] && text.length > 0) {
                            var h = document.createElement('div');
                            h.className = 'tp-shelf-title';
                            h.innerText = text;
                            h.id = headerId;
                            this.boat.appendChild(h);
                            this.cache.processedHeadings[headerId] = true;
                        }
                        continue;
                    }
                    
                    // Extract books
                    var books = cont.querySelectorAll('[id^="book-card-"]');
                    for (var b = 0; b < books.length; b++) {
                        var original = books[b];
                        var bookId = 'tp-book-' + i + '-' + b;
                        
                        if (this.cache.processedBooks[bookId]) continue; // Already processed
                        
                        var clone = original.cloneNode(true);
                        clone.id = bookId;
                        clone.className = 'tp-rescued-card';
                        clone.setAttribute('tabindex', '0');
                        
                        // Clean image
                        var img = clone.querySelector('img');
                        if (img) {
                            img.removeAttribute('class');
                            img.removeAttribute('style');
                            var src = img.getAttribute('src') || img.getAttribute('data-src');
                            if (src) img.src = src;
                        }
                        
                        // Attach click handler
                        var link = original.closest('a') || original.querySelector('a');
                        if (link && link.href) {
                            (function(href, el) {
                                el.onclick = function() { TizenUtils.navigate(href); };
                                el.onkeydown = function(e) { if (e.keyCode === 13) TizenUtils.navigate(href); };
                            })(link.href, clone);
                        }
                        
                        this.boat.appendChild(clone);
                        this.cache.processedBooks[bookId] = true;
                        bookCount++;
                    }
                }
                
                this.log('Rendered ' + bookCount + ' books');
            }
        };
        
        // Start initialization
        ABS.init();
    </script>
    </script>

    <script>
        var PRESETS = {
            "__CORE__": {
                "css": "html{width:1920px!important;margin:0 auto!important}body{background-size:cover!important;background-position:center!important;background-attachment:fixed!important;background-repeat:no-repeat!important;margin:0!important;padding:20px!important;overflow-y:auto!important}*{-webkit-appearance:none!important}img,svg,video{max-width:100%!important;height:auto!important;box-sizing:border-box!important}img[width]{width:auto!important;max-width:100%!important}img[height]{height:auto!important}img[src]{max-width:100%!important;height:auto!important}svg{max-width:100%!important}img.w-4,img.w-6,img.w-8,img.h-4,img.h-6,img.h-8,img.h-10,img.w-10,img.min-w-0,img.min-h-0{width:auto!important;height:auto!important;max-width:50px!important;min-width:auto!important;min-height:auto!important}img[class*=\"w-\"],img[class*=\"h-\"],img[class*=\"min-w\"],img[class*=\"min-h\"],img[class*=\"max-w\"],img[class*=\"max-h\"]{width:auto!important;height:auto!important;max-width:50px!important;min-width:auto!important;min-height:auto!important;max-height:auto!important}button img,a img,nav img,[role=\"navigation\"] img,aside img,.tp-nav-item img{max-width:50px!important;height:auto!important}#tp-proxy-form img,#tp-lifeboat img{max-width:200px!important;height:auto!important;display:block!important}.tp-rescued-card img{width:100%!important;height:160px!important;object-fit:cover!important;display:block!important}:focus{outline:5px solid #FFD700!important}::-webkit-scrollbar{display:none}#tp-proxy-form{background:#222;border:2px solid #FFD700;padding:24px;max-width:420px;margin:60px auto;border-radius:10px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.6)}.tp-input{display:block;width:92%;margin:12px auto;padding:12px;font-size:18px;background:#fff;color:#000;border:none;border-radius:5px}.tp-btn{display:block;width:92%;margin:16px auto;padding:12px;font-size:18px;background:#FFD700;color:#000;font-weight:bold;cursor:pointer;border:none;border-radius:5px}.tp-btn:focus,.tp-input:focus{outline:3px solid #fff}.tp-shelf-title{color:#FFD700!important;font-size:24px!important;font-weight:bold;text-shadow:2px 2px 4px #000;border-bottom:2px solid #FFD700;padding:10px;margin-top:40px;margin-bottom:15px;clear:both;background:rgba(0,0,0,0.4);border-radius:5px}.tp-rescued-card{display:inline-block!important;width:160px!important;min-height:240px!important;margin:15px!important;vertical-align:top!important;position:relative!important;cursor:pointer!important;background:rgba(0,0,0,0.5)!important;box-shadow:3px 3px 10px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);transition:transform 0.1s;transform:translateZ(0)}.tp-rescued-card p,.tp-rescued-card span,.tp-rescued-card div{color:#fff!important;text-shadow:1px 1px 2px #000!important;font-size:13px!important;line-height:1.2!important;background:transparent!important;margin:0!important;padding:3px!important;overflow:hidden!important;text-overflow:ellipsis!important;display:block!important;max-width:100%!important}.tp-rescued-card *{word-break:break-word!important;white-space:normal!important}.tp-rescued-card:focus{outline:4px solid #FFD700!important;transform:scale(1.1) translateZ(0);z-index:5000;background:#000!important}",
                "js": "if(!Element.prototype.closest){Element.prototype.closest=function(s){var el=this;do{if(el.matches(s))return el;el=el.parentElement||el.parentNode}while(el!==null&&el.nodeType===1);return null}}window.TizenUtils={keepAwake:function(){try{var v=document.createElement('video');v.src='https://raw.githubusercontent.com/anthonium/Gestures/master/blank.mp4';v.loop=true;v.play();document.body.appendChild(v)}catch(e){}},lockViewport:function(){var meta=document.querySelector('meta[name=\"viewport\"]');if(!meta){meta=document.createElement('meta');meta.name='viewport';document.head.appendChild(meta)}meta.setAttribute('content','width=1920, initial-scale=1, maximum-scale=1, user-scalable=no');},getParam:function(n){var r=new RegExp('[\\?&]'+n+'=([^&#]*)').exec(location.search);return r===null?'':decodeURIComponent(r[1])},navigate:function(u){if(!u)return;var t=this.getParam('tp');if(t&&u.indexOf('tp=')===-1)u+=(u.indexOf('?')>-1?'&':'?')+'tp='+t;window.location.href=u},handleLogin:function(cont,title){var isVis=function(e){return e&&e.offsetParent!==null&&e.style.display!=='none'&&e.style.visibility!=='hidden'};var inputs=document.querySelectorAll('input,textarea,select,button');var hasVis=false;for(var k=0;k<inputs.length;k++){if(isVis(inputs[k])){hasVis=true;break}}if(!hasVis){if(!p)return false;else return true;}var p=document.getElementById('tp-proxy-form');if(!p){p=document.createElement('div');p.id='tp-proxy-form';p.style.marginBottom='30px';p.style.borderBottom='2px solid #333';if(cont){if(cont.firstChild)cont.insertBefore(p,cont.firstChild);else cont.appendChild(p)}}var els=document.querySelectorAll('input,textarea,select,button');for(var i=0;i<els.length;i++){var o=els[i];if(!isVis(o)||o.hasAttribute('data-tp-pxy'))continue;o.setAttribute('data-tp-pxy','1');var wrapper=document.createElement('div');wrapper.style.margin='10px 0';if(o.tagName==='BUTTON'||(o.tagName==='INPUT'&&(o.type==='submit'||o.type==='button'))){var b=document.createElement('button');b.innerText=o.innerText||o.value||'Submit';b.className='tp-btn';b.tabIndex=0;b.onclick=function(orig){return function(){orig.click()}}(o);wrapper.appendChild(b)}else{var n=document.createElement(o.tagName==='TEXTAREA'?'textarea':'input');if(o.tagName==='INPUT')n.type=o.type;n.className='tp-input';n.placeholder=o.placeholder||o.name||'';n.value=o.value;n.tabIndex=0;(function(orig,pxy){pxy.oninput=function(){orig.value=pxy.value;orig.dispatchEvent(new Event('input'));orig.dispatchEvent(new Event('change'))};pxy.onkeydown=function(e){if(e.keyCode===38||e.keyCode===40){e.preventDefault();var all=Array.prototype.slice.call(document.querySelectorAll('#tp-proxy-form .tp-input, #tp-proxy-form .tp-btn'));var idx=all.indexOf(pxy);if(e.keyCode===38&&idx>0)all[idx-1].focus();if(e.keyCode===40&&idx<all.length-1)all[idx+1].focus()}if(e.keyCode===10009||e.keyCode===27){e.preventDefault();pxy.blur()}if(e.keyCode===13&&orig.form){var s=orig.form.querySelector('button[type=\"submit\"]');if(s)s.click()}}})(o,n);wrapper.appendChild(n)}p.appendChild(wrapper)}return p&&p.childElementCount>0}};TizenUtils.lockViewport();TizenUtils.keepAwake();"
            },
            "abs": { "name": "Audiobookshelf", "css": "", "js": "" },
            "jellyfin": { "name": "Jellyfin", "css": ":focus-visible{outline:4px solid #FFD700!important}", "js": "" }
        };
        
        var USER_AGENTS = [
            { id: "default", name: "ðŸ“º Tizen (Default)", str: null },
            { id: "mobile",  name: "ðŸ“± Mobile (Android)", str: "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Mobile Safari/537.36" },
            { id: "desktop", name: "ðŸ’» Desktop (PC)",     str: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" }
        ];
        
        var apps = JSON.parse(localStorage.getItem('tp_apps') || '[]');
        var selectedIndex = 0; var editIndex = -1; var pressTimer = null;

        function init() {
            PRESETS.abs.css = document.getElementById('abs-css').innerHTML;
            PRESETS.abs.js = document.getElementById('abs-js').innerHTML;

            if (typeof tizen !== 'undefined' && tizen.tvinputdevice) {
                var keys = ["ColorF0Red", "ColorF1Green", "ColorF2Yellow", "ColorF3Blue", "MediaPlay", "MediaPause"];
                for (var i = 0; i < keys.length; i++) { try { tizen.tvinputdevice.registerKey(keys[i]); } catch(e){} }
            }
            var selP = document.getElementById('preset'); Object.keys(PRESETS).forEach(function(k) { if(k!=='__CORE__') selP.innerHTML+='<option value="'+k+'">'+PRESETS[k].name+'</option>'; });
            var selU = document.getElementById('ua'); USER_AGENTS.forEach(function(u) { selU.innerHTML+='<option value="'+u.id+'">'+u.name+'</option>'; });
            render(); showToast("Long Press Enter to Edit"); setInterval(enforceFocus, 200);
        }

        function getIconClass(name) {
            var n = name.toLowerCase();
            if(n.indexOf('home')>-1 || n.indexOf('ha')>-1) return 'fa-home';
            if(n.indexOf('jelly')>-1 || n.indexOf('play')>-1 || n.indexOf('tube')>-1) return 'fa-play-circle';
            if(n.indexOf('book')>-1 || n.indexOf('read')>-1 || n.indexOf('abs')>-1) return 'fa-book';
            return 'fa-globe';
        }

        function render() {
            var g = document.getElementById('grid'); g.innerHTML = '';
            apps.forEach(function(a, i) {
                var d = document.createElement('div'); d.className = 'card'; d.tabIndex = 0;
                var iconClass = getIconClass(a.name);
                var imgHTML = '<img src="https://s2.googleusercontent.com/s2/favicons?domain_url='+encodeURIComponent(a.url)+'&sz=64" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';">';
                var iconHTML = '<i class="fas '+iconClass+'"></i>';
                var box = '<div class="icon-box">' + imgHTML + iconHTML + '</div>';
                d.innerHTML = box + '<span>'+a.name+'</span>';
                (function(app) {
                    d.onclick = function() { launch(app); };
                    d.onkeydown = function(e) { if(e.keyCode===13) launch(app); };
                })(a);
                g.appendChild(d);
            });
            
            var clear = document.createElement('div'); clear.className = 'card'; clear.tabIndex = 0;
            clear.style.borderColor = '#500'; 
            clear.innerHTML = '<div class="icon-box"><i class="fas fa-trash-alt" style="display:block;color:#a00"></i></div><span style="color:#a00">Clear Cache</span>';
            clear.onclick = function() { clearCache(); };
            clear.onkeydown = function(e) { if(e.keyCode===13) clearCache(); };
            g.appendChild(clear);

            var add = document.createElement('div'); add.className = 'card add'; add.tabIndex = 0;
            add.innerHTML = '<i class="fas fa-plus"></i><span>Add App</span>'; g.appendChild(add);
            updateSelection();
        }

        function clearCache() {
            if(confirm("Clear all cached data (TP Config)?")) {
                localStorage.removeItem('tp_conf');
                sessionStorage.removeItem('tp_conf');
                window.location.reload();
            }
        }

        function updateSelection() {
            var cards = document.querySelectorAll('.card');
            if (selectedIndex >= cards.length) selectedIndex = cards.length - 1;
            if (selectedIndex < 0) selectedIndex = 0;
            for (var i = 0; i < cards.length; i++) { if (i === selectedIndex) { cards[i].classList.add('active'); cards[i].focus(); } else { cards[i].classList.remove('active'); } }
        }
        function enforceFocus() { if(document.getElementById('modal').style.display === 'flex') return; var cards = document.querySelectorAll('.card'); if(cards[selectedIndex] && document.activeElement !== cards[selectedIndex]) cards[selectedIndex].focus(); }

        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            var modal = document.getElementById('modal');
            if(modal.style.display === 'flex') { 
                // Handle text field navigation and break-out in modal
                var isTextInput = (document.activeElement && ((document.activeElement.tagName === 'INPUT' && document.activeElement.type !== 'button' && document.activeElement.type !== 'submit') || document.activeElement.tagName === 'TEXTAREA'));
                if (isTextInput) {
                    if (k === 10009 || k === 27) { document.activeElement.blur(); e.preventDefault(); return; }
                    if (k === 38 || k === 40) {
                        var inputs = Array.prototype.slice.call(modal.querySelectorAll('input, textarea, button, select'));
                        var idx = inputs.indexOf(document.activeElement);
                        if (k === 38 && idx > 0) { inputs[idx-1].focus(); e.preventDefault(); }
                        if (k === 40 && idx < inputs.length - 1) { inputs[idx+1].focus(); e.preventDefault(); }
                        return;
                    }
                    return; // Allow left/right editing
                }
                if (k === 10009 || k === 27) { closeModal(); return; }
                return;
            }
            var cols = Math.floor(document.getElementById('grid').offsetWidth / 250) || 3;
            if (k===37) selectedIndex--; if (k===39) selectedIndex++; if (k===38) selectedIndex-=cols; if (k===40) selectedIndex+=cols; 
            if ([37,38,39,40].indexOf(k) > -1) { e.preventDefault(); updateSelection(); }
            if (k===13 && !pressTimer) { pressTimer = setTimeout(function() { pressTimer=null; openModal(selectedIndex); }, 800); }
        });
        document.addEventListener('keyup', function(e) { if (e.keyCode === 13) { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; if (selectedIndex === document.querySelectorAll('.card').length-1) openModal(-1); else launch(apps[selectedIndex]); } } });

        function launch(app) {
            var core = PRESETS['__CORE__']; var preset = PRESETS[app.presetID] || {}; var uaObj = USER_AGENTS.find(function(u){ return u.id === app.ua }) || USER_AGENTS[0];
            var payload = { css: (core.css||'')+'\n'+(preset.css||''), js: (core.js||'')+'\n'+(preset.js||''), ua: uaObj.str };
            window.location.href = app.url + '#tp=' + btoa(JSON.stringify(payload));
        }

        function openModal(index) { 
            editIndex = index; var isAdd = (index === -1 || index >= apps.length);
            document.getElementById('modal-title').innerText = isAdd ? "Add App" : "Edit App"; document.getElementById('btn-delete').style.display = isAdd ? 'none' : 'block';
            if (!isAdd) { var a = apps[index]; document.getElementById('name').value = a.name; document.getElementById('url').value = a.url; document.getElementById('preset').value = a.presetID || ""; document.getElementById('ua').value = a.ua || "default"; } 
            else { document.getElementById('name').value = ""; document.getElementById('url').value = ""; }
            document.getElementById('modal').style.display='flex'; document.getElementById('name').focus(); 
        }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function save() {
            var name=document.getElementById('name').value; var url=document.getElementById('url').value;
            if(name && url) { var appObj = {name:name, url:url, presetID:document.getElementById('preset').value, ua:document.getElementById('ua').value}; if (editIndex > -1 && editIndex < apps.length) apps[editIndex] = appObj; else { apps.push(appObj); selectedIndex = apps.length-1; } localStorage.setItem('tp_apps', JSON.stringify(apps)); closeModal(); render(); }
        }
        function deleteApp() { if(editIndex > -1 && confirm("Delete?")) { apps.splice(editIndex, 1); localStorage.setItem('tp_apps', JSON.stringify(apps)); selectedIndex=Math.max(0,editIndex-1); closeModal(); render(); } }
        function showToast(msg) { var t=document.getElementById('toast'); t.innerText=msg; t.style.opacity=1; setTimeout(function(){t.style.opacity=0;},5000); }
        init();
    </script>
</body>
</html>