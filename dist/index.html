<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TizenPortal 044</title>
    <style>
        body { background: #000; color: #fff; font-family: "Segoe UI", sans-serif; margin: 0; padding: 40px; overflow: hidden; }
        header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        .card { 
            background: #1a1a1a; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; 
            border: 4px solid transparent; border-radius: 8px; font-weight: bold; font-size: 20px; 
            flex-direction: column; gap: 10px; cursor: pointer; opacity: 0.7; transition: transform 0.1s;
            overflow: hidden !important; position: relative; max-width: 100%; min-width: 0;
        }
        .icon-box { width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .icon-box img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .icon-box i { font-size: 50px; color: #888; display: none; }
        .card.active, .card:focus { 
            border-color: #FFD700; background: #333; opacity: 1; transform: scale(1.05); z-index: 10; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); outline: none;
        }
        .add { border: 4px dashed #333; color: #666; }
        .add.active { border-color: #FFD700; color: #fff; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 40px; width: 600px; display: flex; flex-direction: column; gap: 15px; border: 2px solid #555; }
        input, select { padding: 15px; background: #111; color: white; border: 1px solid #444; width: 100%; font-size: 18px; }
        input:focus, select:focus, button:focus { border-color: #FFD700; outline: none; }
        .btn-row { display: flex; gap: 15px; margin-top: 10px; }
        button { flex: 1; padding: 15px; background: #333; color: white; border: 1px solid #555; font-size: 16px; font-weight: bold; }
        button.primary { background: #FFD700; color: black; border-color: #FFD700; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header><h1>TizenPortal <span style="font-size:14px; color:#666;">044</span></h1></header>
    <div id="grid" class="grid"></div>
    <div id="toast">Long Press Enter to Edit</div>
    <div id="modal">
        <div class="box">
            <h2 id="modal-title">Add App</h2>
            <input type="text" id="name" placeholder="Name">
            <input type="url" id="url" placeholder="URL">
            <select id="preset"><option value="">-- No Preset --</option></select>
            <select id="ua"></select>
            <div class="btn-row"><button onclick="closeModal()">Cancel</button><button onclick="save()" class="primary">Save</button></div>
            <button id="btn-delete" onclick="deleteApp()" style="margin-top:10px; background:#500; border:none; display:none;">Delete App</button>
        </div>
    </div>

    <script id="abs-css" type="text/template">
        /* 1. GLOBAL BASICS */
        body { 
            background-image: url('/audiobookshelf/_nuxt/img/wood_default.6d366e7.jpg') !important; 
            background-repeat: repeat !important; 
            background-color: #222 !important; 
            margin: 0 !important; padding: 20px !important; 
            overflow-y: auto !important; 
            font-family: sans-serif !important; 
            color: #fff !important; 
        }

        /* 3. LIFEBOAT MODE (Default) */
        /* We hide the broken app unless we are in form mode. 
           NOTE: Chrome 47 does not support complex :not(.class *) selectors, so we hide by default.
           The .tp-form-mode #__nuxt rule above will override this due to higher specificity. */
        #__nuxt { display: none !important; opacity: 0 !important; }
        
        #tp-lifeboat { display: block; width: 100%; padding-bottom: 50px; margin-top: 70px; }
        #tp-navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(0,0,0,0.9); border-bottom: 2px solid #b8860b; display: flex; align-items: center; padding: 0 20px; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .tp-nav-item { color: #ddd; font-size: 18px; margin-right: 20px; cursor: pointer; padding: 10px; border: 1px solid transparent; }
        .tp-nav-item:focus, .tp-nav-item:hover { color: #FFD700; border-color: #FFD700; background: #333; outline: none; }
    </script>
    
    <script id="abs-js" type="text/template">
        setInterval(function() {
            var boat = document.getElementById('tp-lifeboat');
            var nav = document.getElementById('tp-navbar');
            
            // 0. WAIT FOR NUXT LOAD (Don't scrape while loading spinner is visible)
            var loader = document.getElementById('nuxt-loading');
            if(loader && loader.style.display !== 'none' && loader.style.visibility !== 'hidden' && getComputedStyle(loader).opacity !== '0') {
                return; 
            }

            // A. CREATE LIFEBOAT IF MISSING
            if (!boat) {
                nav = document.createElement('div'); nav.id = 'tp-navbar';
                
                // Dynamic Home URL from Nuxt Config
                var homeUrl = '/';
                if(window.__NUXT__ && window.__NUXT__.config && window.__NUXT__.config.routerBasePath) {
                    homeUrl = window.__NUXT__.config.routerBasePath;
                }

                // Add Home Button manually as anchor
                var homeBtn = document.createElement('div'); homeBtn.className='tp-nav-item'; 
                homeBtn.innerText='Home'; homeBtn.tabIndex=0; 
                homeBtn.onclick = function(){ TizenUtils.navigate(homeUrl); };
                homeBtn.onkeydown = function(e){ if(e.keyCode===13) TizenUtils.navigate(homeUrl); };
                nav.appendChild(homeBtn); 
                
                document.body.appendChild(nav);
                boat = document.createElement('div'); boat.id = 'tp-lifeboat'; document.body.appendChild(boat);
            }

            // B. CHECK FOR LOGIN FORM
            if (window.TizenUtils && window.TizenUtils.handleLogin(boat, 'Audiobookshelf')) {
                return; 
            }

            // C. EXTRACT NAV LINKS (Dynamic Appbar)
            // We look for links in likely sidebar locations
            if (nav && nav.children.length < 6) { 
                var links = document.querySelectorAll('aside a, nav a, .sidebar a, [role="navigation"] a');
                var existing = {};
                // Use textContent for reading, innerText is okay for setting but let's match
                for(var k=0; k<nav.children.length; k++) existing[nav.children[k].textContent] = true;
                
                for(var n=0; n<links.length; n++) {
                    var l = links[n];
                    var txt = l.textContent.trim(); // CHANGED: innerText -> textContent
                    if(txt && txt.length > 2 && !existing[txt] && l.href && l.href.indexOf('javascript')===-1) {
                         (function(t, u){
                             var btn = document.createElement('div'); btn.className='tp-nav-item'; 
                             btn.innerText=t; btn.tabIndex=0; 
                             btn.onclick = function(){ TizenUtils.navigate(u); }; 
                             btn.onkeydown = function(e){ if(e.keyCode===13) TizenUtils.navigate(u); };
                             nav.appendChild(btn);
                         })(txt, l.href);
                         existing[txt] = true;
                         if(Object.keys(existing).length >= 6) break;
                    }
                }
            }

            // D. EXTRACT BOOKS
            var containers = document.querySelectorAll('div.relative');
            for (var i=0; i<containers.length; i++) {
                var cont = containers[i];
                
                // 1. Headings
                var placard = cont.querySelector('.categoryPlacard');
                if (placard) {
                    var text = placard.textContent.trim(); // CHANGED: innerText -> textContent
                    var headerId = 'tp-head-' + i;
                    if (!document.getElementById(headerId) && text.length > 0) {
                        var h = document.createElement('div'); h.className = 'tp-shelf-title'; h.innerText = text; h.id = headerId; boat.appendChild(h);
                    } continue;
                }
                
                // 2. Books
                var books = cont.querySelectorAll('[id^="book-card-"]');
                if (books.length > 0) {
                    for (var b=0; b<books.length; b++) {
                        var original = books[b];
                        var bookId = 'tp-book-' + i + '-' + b;
                        if (!document.getElementById(bookId)) {
                            var clone = original.cloneNode(true); 
                            clone.id = bookId; clone.className = 'tp-rescued-card'; clone.setAttribute('tabindex', '0');
                            
                            // CLEAN THE IMAGE
                            var img = clone.querySelector('img');
                            if(img) {
                                img.removeAttribute('class'); 
                                img.removeAttribute('style'); 
                                var src = img.getAttribute('src') || img.getAttribute('data-src');
                                if(src) img.src = src; 
                            }

                            // FIX CLICKS
                            var link = original.closest('a') || original.querySelector('a');
                            if (link && link.href) { 
                                (function(l) {
                                    clone.onclick = function() { TizenUtils.navigate(l); }; 
                                    clone.onkeydown = function(e) { if(e.keyCode===13) TizenUtils.navigate(l); };
                                })(link.href);
                            } else { 
                                (function(orig) {
                                    clone.onclick = function() { orig.click(); }; 
                                    clone.onkeydown = function(e) { if(e.keyCode===13) orig.click(); };
                                })(original);
                            }
                            boat.appendChild(clone);
                        }
                    }
                }
            }
        }, 2000);
    </script>

    <script>
        var PRESETS = {
            "__CORE__": { 
                "css": "img,svg,video{max-width:100%!important;height:auto!important}:focus{outline:5px solid #FFD700!important}::-webkit-scrollbar{display:none}#tp-proxy-form{background:#222;border:2px solid #FFD700;padding:40px;max-width:500px;margin:100px auto;border-radius:10px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.8)}.tp-input{display:block;width:90%;margin:15px auto;padding:15px;font-size:20px;background:#fff;color:#000;border:none;border-radius:5px}.tp-btn{display:block;width:90%;margin:20px auto;padding:15px;font-size:20px;background:#FFD700;color:#000;font-weight:bold;cursor:pointer;border:none;border-radius:5px}.tp-btn:focus,.tp-input:focus{outline:4px solid #fff}.tp-shelf-title{color:#FFD700!important;font-size:24px!important;font-weight:bold;text-shadow:2px 2px 4px #000;border-bottom:2px solid rgba(255,215,0,0.3);padding-bottom:5px;margin-top:40px;margin-bottom:15px;clear:both}.tp-rescued-card{display:inline-block!important;width:160px!important;min-height:240px!important;margin:15px!important;vertical-align:top!important;position:relative!important;cursor:pointer!important;background:rgba(0,0,0,0.5)!important;box-shadow:3px 3px 10px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);transition:transform 0.1s;transform:translateZ(0)}.tp-rescued-card img{width:100%!important;height:160px!important;object-fit:cover!important;display:block!important;opacity:1!important;visibility:visible!important;max-width:100%!important}.tp-rescued-card p,.tp-rescued-card span,.tp-rescued-card div{color:#fff!important;text-shadow:1px 1px 2px #000!important;font-size:13px!important;line-height:1.2!important;background:transparent!important}.tp-rescued-card:focus{outline:4px solid #FFD700!important;transform:scale(1.1) translateZ(0);z-index:5000;background:#000!important}", 
                "js": "if(!Element.prototype.closest){Element.prototype.closest=function(s){var el=this;do{if(el.matches(s))return el;el=el.parentElement||el.parentNode}while(el!==null&&el.nodeType===1);return null}}window.TizenUtils={keepAwake:function(){try{var v=document.createElement('video');v.src='https://raw.githubusercontent.com/anthonium/Gestures/master/blank.mp4';v.loop=true;v.play();document.body.appendChild(v)}catch(e){}}, getParam:function(n){var r=new RegExp('[\\\\?&]'+n+'=([^&#]*)').exec(location.search);return r===null?'':decodeURIComponent(r[1])}, navigate:function(u){if(!u)return;var t=this.getParam('tp');if(t&&u.indexOf('tp=')===-1)u+=(u.indexOf('?')>-1?'&':'?')+'tp='+t;window.location.href=u}, handleLogin:function(cont, title){var f=document.querySelector('form')||document.querySelector('input[type=\"password\"]');var p=document.getElementById('tp-proxy-form');if(f){if(!p){if(cont)cont.innerHTML='';p=document.createElement('div');p.id='tp-proxy-form';var h=document.createElement('h2');h.innerText='Login to '+(title||'App');h.style.color='#FFD700';p.appendChild(h);var inps=document.querySelectorAll('input');for(var i=0;i<inps.length;i++){var o=inps[i];if(o.type==='hidden'||o.style.display==='none')continue;var n=document.createElement('input');n.type=o.type;n.placeholder=o.placeholder||(o.type==='password'?'Password':'Username');n.className='tp-input';n.tabIndex=0;(function(orig,pxy){pxy.oninput=function(){orig.value=pxy.value;var e=document.createEvent('HTMLEvents');e.initEvent('input',true,true);orig.dispatchEvent(e)};pxy.onkeydown=function(k){if(k.keyCode===13){var b=document.getElementById('tp-proxy-btn');if(b)b.click()}}})(o,n);p.appendChild(n)}var btn=document.querySelector('button[type=\"submit\"]')||document.querySelector('button.submit')||document.querySelector('form button');if(btn){var b=document.createElement('button');b.id='tp-proxy-btn';b.innerText=btn.innerText||'Login';b.className='tp-btn';b.tabIndex=0;b.onclick=function(){btn.click()};p.appendChild(b)}if(cont)cont.appendChild(p)}return true}else{if(p){p.parentNode.removeChild(p);if(cont)cont.innerHTML=''}return false}}};window.TizenUtils.keepAwake();" 
            },
            "abs": { "name": "Audiobookshelf", "css": "", "js": "" },
            "jellyfin": { "name": "Jellyfin", "css": ":focus-visible{outline:4px solid #FFD700!important}", "js": "" }
        };
        
        var USER_AGENTS = [
            { id: "default", name: "ðŸ“º Tizen (Default)", str: null },
            { id: "mobile",  name: "ðŸ“± Mobile (Android)", str: "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.162 Mobile Safari/537.36" },
            { id: "desktop", name: "ðŸ’» Desktop (PC)",     str: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" }
        ];
        
        var apps = JSON.parse(localStorage.getItem('tp_apps') || '[]');
        var selectedIndex = 0; var editIndex = -1; var pressTimer = null;

        function init() {
            PRESETS.abs.css = document.getElementById('abs-css').innerHTML;
            PRESETS.abs.js = document.getElementById('abs-js').innerHTML;

            if (typeof tizen !== 'undefined' && tizen.tvinputdevice) {
                var keys = ["ColorF0Red", "ColorF1Green", "ColorF2Yellow", "ColorF3Blue", "MediaPlay", "MediaPause"];
                for (var i = 0; i < keys.length; i++) { try { tizen.tvinputdevice.registerKey(keys[i]); } catch(e){} }
            }
            var selP = document.getElementById('preset'); Object.keys(PRESETS).forEach(function(k) { if(k!=='__CORE__') selP.innerHTML+='<option value="'+k+'">'+PRESETS[k].name+'</option>'; });
            var selU = document.getElementById('ua'); USER_AGENTS.forEach(function(u) { selU.innerHTML+='<option value="'+u.id+'">'+u.name+'</option>'; });
            render(); showToast("Long Press Enter to Edit"); setInterval(enforceFocus, 200);
        }

        function getIconClass(name) {
            var n = name.toLowerCase();
            if(n.indexOf('home')>-1 || n.indexOf('ha')>-1) return 'fa-home';
            if(n.indexOf('jelly')>-1 || n.indexOf('play')>-1 || n.indexOf('tube')>-1) return 'fa-play-circle';
            if(n.indexOf('book')>-1 || n.indexOf('read')>-1 || n.indexOf('abs')>-1) return 'fa-book';
            return 'fa-globe';
        }

        function render() {
            var g = document.getElementById('grid'); g.innerHTML = '';
            apps.forEach(function(a, i) {
                var d = document.createElement('div'); d.className = 'card'; d.tabIndex = 0;
                var iconClass = getIconClass(a.name);
                var imgHTML = '<img src="https://s2.googleusercontent.com/s2/favicons?domain_url='+encodeURIComponent(a.url)+'&sz=64" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';">';
                var iconHTML = '<i class="fas '+iconClass+'"></i>';
                var box = '<div class="icon-box">' + imgHTML + iconHTML + '</div>';
                d.innerHTML = box + '<span>'+a.name+'</span>';
                g.appendChild(d);
            });
            var add = document.createElement('div'); add.className = 'card add'; add.tabIndex = 0;
            add.innerHTML = '<i class="fas fa-plus"></i><span>Add App</span>'; g.appendChild(add);
            updateSelection();
        }

        function updateSelection() {
            var cards = document.querySelectorAll('.card');
            if (selectedIndex >= cards.length) selectedIndex = cards.length - 1;
            if (selectedIndex < 0) selectedIndex = 0;
            for (var i = 0; i < cards.length; i++) { if (i === selectedIndex) { cards[i].classList.add('active'); cards[i].focus(); } else { cards[i].classList.remove('active'); } }
        }
        function enforceFocus() { if(document.getElementById('modal').style.display === 'flex') return; var cards = document.querySelectorAll('.card'); if(cards[selectedIndex] && document.activeElement !== cards[selectedIndex]) cards[selectedIndex].focus(); }

        document.addEventListener('keydown', function(e) {
            var k = e.keyCode;
            if(document.getElementById('modal').style.display === 'flex') { if(k===10009||k===27) closeModal(); return; }
            var cols = Math.floor(document.getElementById('grid').offsetWidth / 250) || 3;
            if (k===37) selectedIndex--; if (k===39) selectedIndex++; if (k===38) selectedIndex-=cols; if (k===40) selectedIndex+=cols; 
            if ([37,38,39,40].indexOf(k) > -1) { e.preventDefault(); updateSelection(); }
            if (k===13 && !pressTimer) { pressTimer = setTimeout(function() { pressTimer=null; openModal(selectedIndex); }, 800); }
        });
        document.addEventListener('keyup', function(e) { if (e.keyCode === 13) { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; if (selectedIndex === document.querySelectorAll('.card').length-1) openModal(-1); else launch(apps[selectedIndex]); } } });

        function launch(app) {
            var core = PRESETS['__CORE__']; var preset = PRESETS[app.presetID] || {}; var uaObj = USER_AGENTS.find(function(u){ return u.id === app.ua }) || USER_AGENTS[0];
            var payload = { css: (core.css||'')+'\n'+(preset.css||''), js: (core.js||'')+'\n'+(preset.js||''), ua: uaObj.str };
            window.location.href = app.url + (app.url.indexOf('?') > -1 ? '&' : '?') + 'tp=' + btoa(JSON.stringify(payload));
        }

        function openModal(index) { 
            editIndex = index; var isAdd = (index === -1 || index >= apps.length);
            document.getElementById('modal-title').innerText = isAdd ? "Add App" : "Edit App"; document.getElementById('btn-delete').style.display = isAdd ? 'none' : 'block';
            if (!isAdd) { var a = apps[index]; document.getElementById('name').value = a.name; document.getElementById('url').value = a.url; document.getElementById('preset').value = a.presetID || ""; document.getElementById('ua').value = a.ua || "default"; } 
            else { document.getElementById('name').value = ""; document.getElementById('url').value = ""; }
            document.getElementById('modal').style.display='flex'; document.getElementById('name').focus(); 
        }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function save() {
            var name=document.getElementById('name').value; var url=document.getElementById('url').value;
            if(name && url) { var appObj = {name:name, url:url, presetID:document.getElementById('preset').value, ua:document.getElementById('ua').value}; if (editIndex > -1 && editIndex < apps.length) apps[editIndex] = appObj; else { apps.push(appObj); selectedIndex = apps.length-1; } localStorage.setItem('tp_apps', JSON.stringify(apps)); closeModal(); render(); }
        }
        function deleteApp() { if(editIndex > -1 && confirm("Delete?")) { apps.splice(editIndex, 1); localStorage.setItem('tp_apps', JSON.stringify(apps)); selectedIndex=Math.max(0,editIndex-1); closeModal(); render(); } }
        function showToast(msg) { var t=document.getElementById('toast'); t.innerText=msg; t.style.opacity=1; setTimeout(function(){t.style.opacity=0;},5000); }
        init();
    </script>
</body>
</html>